<?xml version="1.0" encoding="ascii"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
          "DTD/xhtml1-transitional.dtd">
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
 <head>
  <title>
   mari.system._ocio_filter
  </title>
  <link href="epydoc.css" rel="stylesheet" type="text/css"/>
  <script src="epydoc.js" type="text/javascript">
  </script>
 </head>
 <body alink="#204080" bgcolor="white" link="blue" text="black" vlink="#204080">
  <!-- ==================== NAVIGATION BAR ==================== -->
  <table cellpadding="0" cellspacing="0" width="100%">
   <tr valign="top">
    <td width="100%">
     <span class="breadcrumbs">
      <a href="mari-module.html">
       Package&nbsp;mari
      </a>
      ::
      <a href="mari.system-module.html">
       Package&nbsp;system
      </a>
      ::
        Module&nbsp;_ocio_filter
     </span>
    </td>
    <td>
     <table cellpadding="0" cellspacing="0">
      <!-- hide/show private -->
      <tr>
       <td align="right">
        <span class="options">
         [
         <a href="frames.html" target="_top">
          frames
         </a>
         ]&nbsp;|&nbsp;
         <a href="mari.system._ocio_filter-pysrc.html" target="_top">
          no&nbsp;frames
         </a>
         ]
        </span>
       </td>
      </tr>
     </table>
    </td>
   </tr>
  </table>
  <h1 class="epydoc">
   Source Code for
   <a href="mari.system._ocio_filter-module.html" onclick="show_private();">
    Module mari.system._ocio_filter
   </a>
  </h1>
  <pre class="py-src">
&iuml;&raquo;&iquest;#-------------------------------------------------------------------------------
# Post processing (color management) related Mari scripts
# coding: utf-8
# Copyright (c) 2011 The Foundry Visionmongers Ltd.  All Rights Reserved.
#-------------------------------------------------------------------------------

import mari, time, PySide2, os, math
QtCore = PySide2.QtCore
ocio = mari.utils.ocio

##############################################################################################

filter = None

class OcioFilter():

    #-----------------------------------------------------------------------------------------

    def __init__(self):
        ocio.printMessage(ocio.MessageType.DEBUG, 'OcioFilter constructor')

        # Default all members...
        self._config_file_list   = mari.FileList(ocio.CONFIG_FILE_LIST_DEFAULT)
        self._config             = ocio.CONFIG_DEFAULT
        self._input_color_space  = ocio.INPUT_COLORSPACE_DEFAULT
        self._output_color_space = ocio.INPUT_COLORSPACE_DEFAULT
        self._filter_cache_id    = None
        self._texture_cache_id   = None
        self._sampler_name       = None

        # Always rebuild the filter from scratch.
        self._filter = mari.gl_render.findQuickApplyFilter('Color Correction')
        if self._filter is not None:
            mari.gl_render.removeQuickApplyFilter(self._filter)
        self._filter = mari.gl_render.createQuickApplyGLSL('Color Correction', '', '', 'ColorManager.png')

        self._filter.setMetadata('ConfigPath', self._config_file_list)
        self._filter.setMetadataDisplayName('ConfigPath', 'OCIO Config')
        self._filter.setMetadataDefault('ConfigPath', ocio.CONFIG_FILE_LIST_RESET)
        self._filter.setMetadataFlags('ConfigPath', self._filter.METADATA_VISIBLE | self._filter.METADATA_EDITABLE)

        color_spaces = [color_space.getName() for color_space in self._config.getColorSpaces()]

        color_space_reset = ocio.INPUT_COLORSPACE_DEFAULT
        if color_spaces.count(color_space_reset) == 0:
            color_space_reset = color_spaces[0]

        self._filter.setMetadata('InputColorSpace', self._input_color_space)
        self._filter.setMetadataDisplayName('InputColorSpace', 'Input Colorspace')
        self._filter.setMetadataDefault('InputColorSpace', color_space_reset)
        self._filter.setMetadataItemList('InputColorSpace', color_spaces)
        self._filter.setMetadataFlags('InputColorSpace', self._filter.METADATA_VISIBLE | self._filter.METADATA_EDITABLE)

        self._filter.setMetadata('OutputColorSpace', self._output_color_space)
        self._filter.setMetadataDisplayName('OutputColorSpace', 'Output Colorspace')
        self._filter.setMetadataDefault('OutputColorSpace', color_space_reset)
        self._filter.setMetadataItemList('OutputColorSpace', color_spaces)
        self._filter.setMetadataFlags('OutputColorSpace', self._filter.METADATA_VISIBLE | self._filter.METADATA_EDITABLE)

        #mari.utils.connect(self._filter.metadataValueChanged, self._metadataValueChanged)
        QtCore.QObject.connect(self._filter, QtCore.SIGNAL('metadataValueChanged(QString,QVariant)'), self._metadataValueChanged)

        self._rebuildFilter()

    #-----------------------------------------------------------------------------------------

    def _metadataValueChanged(self, name, value):
        ocio.printMessage(ocio.MessageType.DEBUG, 'Metadata \'%s\' changed to \'%s\'' % (name, value))

        if name == 'ConfigPath':
            if value == self._config_file_list:
                return
            self._config_file_list = mari.FileList(value)
            self._config           = ocio.loadConfig(self._config_file_list.at(0), False)

            color_spaces = [color_space.getName() for color_space in self._config.getColorSpaces()]

            color_space_reset = ocio.INPUT_COLORSPACE_DEFAULT
            if color_spaces.count(color_space_reset) == 0:
                color_space_reset = color_spaces[0]

            if color_spaces.count(self._input_color_space) == 0:
                self._input_color_space = color_space_reset

            if color_spaces.count(self._output_color_space) == 0:
                self._output_color_space = color_space_reset

            self._filter.setMetadataItemList('InputColorSpace',  color_spaces)
            self._filter.setMetadataItemList('OutputColorSpace', color_spaces)
            self._filter.setMetadataDefault('InputColorSpace',  color_space_reset)
            self._filter.setMetadataDefault('OutputColorSpace', color_space_reset)
            self._filter.setMetadata('InputColorSpace',  self._input_color_space )
            self._filter.setMetadata('OutputColorSpace', self._output_color_space)

        elif name == 'InputColorSpace':
            if value == self._input_color_space:
                return
            self._input_color_space = value

        elif name == 'OutputColorSpace':
            if value == self._output_color_space:
                return
            self._output_color_space = value

        else:
            return

        self._rebuildFilter()

    #-----------------------------------------------------------------------------------------

    def _rebuildFilter(self):
        try:
            input_color_space = self._config.getColorSpace(self._input_color_space)
            if input_color_space is not None:
                output_color_space = self._config.getColorSpace(self._output_color_space)
                if output_color_space is not None:
                    processor = self._config.getProcessor(input_color_space, output_color_space)

                    self._filter_cache_id, self._texture_cache_id, self._sampler_name = ocio.buildProcessorFilter(
                        processor,
                        self._filter,
                        self._filter_cache_id,
                        self._texture_cache_id,
                        mari.ocio.lutSize())

                    current_canvas = mari.canvases.current()
                    if current_canvas is not None:
                        current_canvas.requestRepaint()

        except Exception, e:
            message = 'Failed to build filter due to \'%s\'' % e
            ocio.printMessage(ocio.MessageType.ERROR, '%s' % message)
            if not mari.app.inTerminalMode():
                mari.utils.misc.message(message, 'Colorspace', 1024, 2)

##############################################################################################

if mari.app.isRunning():
    if not hasattr(mari.gl_render, 'createQuickApplyGLSL'):
        printMessage(MessageType.ERROR, 'This version of Mari does not support the mari.gl_render.createQuickApplyGLSL API')

    elif ocio is not None and ocio.CONFIG_DEFAULT is not None:
        ocio.printMessage(ocio.MessageType.DEBUG, 'Create OpenColorIO filter')
        filter = OcioFilter()
<script type="text/javascript">
<!--
expandto(location.href);
// -->
</script>
</pre>
  <br/>
  <!-- ==================== NAVIGATION BAR ==================== -->
  <table border="0" cellpadding="0" cellspacing="0" width="100%%">
   <tr>
   </tr>
  </table>
  <script type="text/javascript">
   <!--
  // Private objects are initially displayed (because if
  // javascript is turned off then we want them to be
  // visible); but by default, we want to hide them.  So hide
  // them unless we have a cookie that says to show them.
  checkCookie();
  // -->
  </script>
 </body>
</html>
